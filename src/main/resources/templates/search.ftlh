<#assign title="–ü–æ–∏—Å–∫ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤">
<#include "base.ftlh">

<@base>
    <div class="card">
        <h1>üîç –ü–æ–∏—Å–∫ —è–∑—ã–∫–æ–≤—ã—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤</h1>
        <p>–ù–∞–π–¥–∏—Ç–µ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –¥–ª—è —è–∑—ã–∫–æ–≤–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ –ø–æ –≤–∞—à–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º</p>

        <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
        <form id="searchForm" method="get" action="/search" style="margin-top: 2rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                <div class="form-group">
                    <label for="nativeLanguage">–†–æ–¥–Ω–æ–π —è–∑—ã–∫ –ø–∞—Ä—Ç–Ω–µ—Ä–∞:</label>
                    <select id="nativeLanguage" name="nativeLanguage">
                        <option value="">–õ—é–±–æ–π —è–∑—ã–∫</option>
                        <option value="russian" <#if searchNativeLanguage?? && searchNativeLanguage == "russian">selected</#if>>–†—É—Å—Å–∫–∏–π</option>
                        <option value="english" <#if searchNativeLanguage?? && searchNativeLanguage == "english">selected</#if>>–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
                        <option value="spanish" <#if searchNativeLanguage?? && searchNativeLanguage == "spanish">selected</#if>>–ò—Å–ø–∞–Ω—Å–∫–∏–π</option>
                        <option value="french" <#if searchNativeLanguage?? && searchNativeLanguage == "french">selected</#if>>–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π</option>
                        <option value="german" <#if searchNativeLanguage?? && searchNativeLanguage == "german">selected</#if>>–ù–µ–º–µ—Ü–∫–∏–π</option>
                        <option value="chinese" <#if searchNativeLanguage?? && searchNativeLanguage == "chinese">selected</#if>>–ö–∏—Ç–∞–π—Å–∫–∏–π</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="learningLanguage">–ò–∑—É—á–∞–µ–º—ã–π —è–∑—ã–∫ –ø–∞—Ä—Ç–Ω–µ—Ä–∞:</label>
                    <select id="learningLanguage" name="learningLanguage">
                        <option value="">–õ—é–±–æ–π —è–∑—ã–∫</option>
                        <option value="russian" <#if searchLearningLanguage?? && searchLearningLanguage == "russian">selected</#if>>–†—É—Å—Å–∫–∏–π</option>
                        <option value="english" <#if searchLearningLanguage?? && searchLearningLanguage == "english">selected</#if>>–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
                        <option value="spanish" <#if searchLearningLanguage?? && searchLearningLanguage == "spanish">selected</#if>>–ò—Å–ø–∞–Ω—Å–∫–∏–π</option>
                        <option value="french" <#if searchLearningLanguage?? && searchLearningLanguage == "french">selected</#if>>–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π</option>
                        <option value="german" <#if searchLearningLanguage?? && searchLearningLanguage == "german">selected</#if>>–ù–µ–º–µ—Ü–∫–∏–π</option>
                        <option value="chinese" <#if searchLearningLanguage?? && searchLearningLanguage == "chinese">selected</#if>>–ö–∏—Ç–∞–π—Å–∫–∏–π</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>–ò–Ω—Ç–µ—Ä–µ—Å—ã –ø–∞—Ä—Ç–Ω–µ—Ä–∞ (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ):</label>
                <div class="checkbox-group">
                    <#if interests??>
                        <#list interests as interest>
                            <div class="checkbox-item">
                                <input type="checkbox" id="interest-${interest.id}" name="interests"
                                       value="${interest.id}"
                                       <#if searchInterests?? && searchInterests?seq_contains(interest.id)>checked</#if>>
                                <label for="interest-${interest.id}">${interest.name}</label>
                            </div>
                        </#list>
                    </#if>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="submit" class="btn btn-primary">
                    üîç –ù–∞–π—Ç–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
                </button>
                <button type="button" class="btn btn-outline" onclick="clearSearch()">
                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                </button>
            </div>
        </form>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
    <#if searchPerformed?? && searchPerformed>
        <div class="card">
            <h2>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
                <span style="font-size: 1rem; color: #666;">
                    (–Ω–∞–π–¥–µ–Ω–æ: <#if partners??>${partners?size}<#else>0</#if>)
                </span>
            </h2>

            <#if partners?? && partners?size gt 0>
                <div id="partnersList" class="partners-grid">
                    <#list partners as partner>
                        <div class="partner-card">
                            <div class="partner-header">
                                <div class="partner-avatar">üë§</div>
                                <div class="partner-info">
                                    <h3>${partner.username}</h3>
                                    <span class="partner-level">
                                        <#if partner.level == "beginner">üéØ –ù–∞—á–∏–Ω–∞—é—â–∏–π
                                        <#elseif partner.level == "intermediate">‚ö° –°—Ä–µ–¥–Ω–∏–π
                                        <#elseif partner.level == "advanced">üöÄ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π
                                        <#elseif partner.level == "native">üèÜ –ù–æ—Å–∏—Ç–µ–ª—å
                                        <#else>‚ùì –ù–µ —É–∫–∞–∑–∞–Ω
                                        </#if>
                                    </span>
                                </div>
                            </div>

                            <div class="partner-languages">
                                <div class="language-item">
                                    <span class="language-label">üó£Ô∏è –†–æ–¥–Ω–æ–π:</span>
                                    <span class="language-value">${partner.nativeLanguage!"–ù–µ —É–∫–∞–∑–∞–Ω"}</span>
                                </div>
                                <div class="language-item">
                                    <span class="language-label">üìö –ò–∑—É—á–∞–µ—Ç:</span>
                                    <span class="language-value">${partner.learningLanguage!"–ù–µ —É–∫–∞–∑–∞–Ω"}</span>
                                </div>
                            </div>

                            <#assign partnerInterests = partner.getInterests()![]>
                            <#if partnerInterests?size gt 0>
                                <div class="partner-interests">
                                    <strong>–ò–Ω—Ç–µ—Ä–µ—Å—ã:</strong>
                                    <div class="interests-list">
                                        <#list partnerInterests as interest>
                                            <span class="interest-tag">${interest.name}</span>
                                        </#list>
                                    </div>
                                </div>
                            </#if>

                            <div class="partner-actions">
                                <button class="btn btn-primary btn-small" onclick="startSession(${partner.id})">
                                    üí¨ –ù–∞—á–∞—Ç—å —Å–µ—Å—Å–∏—é
                                </button>
                                <button class="btn btn-outline btn-small" onclick="viewProfile(${partner.id})">
                                    üëÄ –ü—Ä–æ—Ñ–∏–ª—å
                                </button>
                            </div>
                        </div>
                    </#list>
                </div>
            <#else>
                <div style="text-align: center; padding: 3rem; color: #666;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üòî</div>
                    <h3>–ü–∞—Ä—Ç–Ω–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞</p>
                </div>
            </#if>
        </div>
    </#if>
</@base>

<style>
    .partners-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }

    .partner-card {
        background: white;
        border: 1px solid #e1e5e9;
        border-radius: 10px;
        padding: 1.5rem;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .partner-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .partner-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .partner-avatar {
        font-size: 2rem;
        width: 60px;
        height: 60px;
        background: #f8f9fa;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .partner-info h3 {
        margin: 0;
        color: #2c3e50;
    }

    .partner-level {
        font-size: 0.8rem;
        color: #7f8c8d;
    }

    .partner-languages {
        margin-bottom: 1rem;
    }

    .language-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #f8f9fa;
    }

    .language-label {
        font-weight: 500;
        color: #666;
    }

    .language-value {
        color: #2c3e50;
    }

    .partner-interests {
        margin-bottom: 1rem;
    }

    .interests-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem;
        margin-top: 0.5rem;
    }

    .interest-tag {
        background: #e3f2fd;
        color: #1976d2;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
    }

    .partner-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-small {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
        flex: 1;
    }

    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.8rem;
        margin-top: 0.5rem;
    }
</style>

<script>
    function clearSearch() {
        document.getElementById('nativeLanguage').value = '';
        document.getElementById('learningLanguage').value = '';

        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => checkbox.checked = false);

        document.getElementById('searchForm').submit();
    }

    function startSession(partnerId) {
        if (confirm('–ù–∞—á–∞—Ç—å —è–∑—ã–∫–æ–≤—É—é —Å–µ—Å—Å–∏—é —Å —ç—Ç–∏–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º?')) {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç AJAX –∑–∞–ø—Ä–æ—Å
            alert('–°–µ—Å—Å–∏—è –Ω–∞—á–∞—Ç–∞! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —á–∞—Ç—É...');
            // window.location.href = '/session/start?partnerId=' + partnerId;
        }
    }

    function viewProfile(partnerId) {
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å –ø–∞—Ä—Ç–Ω–µ—Ä–∞
        alert('–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞ ID: ' + partnerId);
        // window.location.href = '/profile/' + partnerId;
    }

    // AJAX –ø–æ–∏—Å–∫ (–¥–ª—è –±—É–¥—É—â–µ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è)
    function performSearch() {
        const formData = new FormData(document.getElementById('searchForm'));

        fetch('/search', {
            method: 'GET',
            body: new URLSearchParams(formData)
        })
            .then(response => response.text())
            .then(html => {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newResults = doc.querySelector('#partnersList');
                if (newResults) {
                    document.getElementById('partnersList').innerHTML = newResults.innerHTML;
                }
            })
            .catch(error => console.error('Search error:', error));
    }
</script>